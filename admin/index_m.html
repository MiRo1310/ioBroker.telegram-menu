<html>

<head>
	<!-- Load ioBroker scripts and styles-->
	<link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
	<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

	<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>

	<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
	<script type="text/javascript" src="./js/main.js"></script>
	<script type="text/javascript" src="./js/component.js"></script>

	<script type="text/javascript" src="../../js/translate.js"></script>
	<script type="text/javascript" src="../../lib/js/materialize.js"></script>
	<script type="text/javascript" src="../../js/adapter-settings.js"></script>

	<link type="text/css" rel="stylesheet" href="../../lib/css/themes/jquery-ui/default/jquery-ui.min.css">
	<link type="text/css" rel="stylesheet" href="../../lib/css/fancytree/ui.fancytree.min.css" />
	<link rel="stylesheet" type="text/css" href="../../lib/css/iob/selectID.css" />

	<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
	<script type="text/javascript" src="../../lib/js/jquery.fancytree-all.min.js"></script>
	<script type="text/javascript" src="../../lib/js/selectID.js"></script>

	<!-- Load our own files -->
	<link rel="stylesheet" type="text/css" href="style.css" />
	<script type="text/javascript" src="words.js"></script>

	<script type="text/javascript">
		let _onChange
		var users;
		let activeUser;
		// This will be called by the admin adapter when the settings page loads
		function load(settings, onChange) {
			// example: select elements with id=key and class=value and insert value
			if (!settings) return;
			_onChange = onChange
			users = settings.users
			activeUser = settings.users[0]
			createUser("#user_list", settings.users)
			fillTable("#navigation", settings.data.nav, newTableRow_Nav, users)
			fillTableAction(settings.data.action)
			showAddGlobalUser(users)
			showHideUserEntry(activeUser)
			showGlobalUserSettings(activeUser)
			setCheckbox(settings.checkbox)
			generateSelectTrigger(activeUser)
			if (settings.instance) $("#select_instance").val(settings.instance)




			$('.value').each(function () {
				var $key = $(this);
				var id = $key.attr('id');
				if ($key.attr('type') === 'checkbox') {
					// do not call onChange direct, because onChange could expect some arguments
					$key.prop('checked', settings[id])
						.on('change', () => onChange())
						;
				} else {
					// do not call onChange direct, because onChange could expect some arguments
					$key.val(settings[id])
						.on('change', () => onChange())
						.on('keyup', () => onChange())
						;
				}
			});

			onChange(false);
			// reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
			if (M) M.updateTextFields();

		}

		// This will be called by the admin adapter when the user presses the save button
		function save(callback) {

			// example: select elements with class=value and build settings object
			var obj = {};
			obj.checkbox = []
			$('.value').each(function () {
				var $this = $(this);
				if ($this.attr('type') === 'checkbox') {
					obj[$this.attr('id')] = $this.prop('checked');

				} else if ($this.attr('type') === 'number') {
					obj[$this.attr('id')] = parseFloat($this.val());

				} else if (!$this.attr("data-nosave")) {
					obj[$this.attr('id')] = $this.val();

				}
			});

			$(".valCheckbox").each(function () {
				var $this = $(this);
				if ($this.attr('type') === 'checkbox') {
					obj.checkbox.push({ [$this.attr('id')]: $this.prop('checked') });
				}

			})


			const tableDevices = table2Values(".saveTable");

			if (isStringEmty(".isString")) {
				obj.instance = $("#select_instance").val()
				obj.data = tableDevices;
				obj.users = users
				obj.startsides = generateStartside(users)
				generateSelectTrigger(activeUser)

				console.log(obj)
				callback(obj);
			}
		}



		$(function () {


			let rowToUpdate;
			// New User Show Button			
			$("#username").keyup(function () {
				if ($(this).val() !== "" && users.indexOf($("#username").val()) == -1) {
					$("#addNewUser").removeClass("disabled")
				} else $("#addNewUser").addClass("disabled")
			})

			// Add new User
			$("#addNewUser").click(() => {
				let newUser = $("#username").val()

				if (users.indexOf(newUser) == -1) {
					addNewUser(users, newUser, _onChange)
					activeUser = newUser
					showUser(newUser)
				}
			})
			// Delete User
			$("#user_menu").on("click", "#deleteUser", function () {
				let userdelete = $("#user_list .active").attr("name")
				if (userdelete == "Global") {
					$(".showGlobal").hide()
					$("#globalUserActiv").prop("checked", false)
					// console.log($("#globalUserActiv").is(":checked"))
				}
				users.splice(users.indexOf(userdelete), 1)
				$("#user_list .active").parent().remove()
				$(`#tabel_nav tbody[name="${userdelete}"]`)
				$(`#${userdelete}`).remove()
				showAddGlobalUser(users)
				_onChange()

			})
			// Click User, Show User Navigation, Action
			$("#user_list").on("click", ".click_user", function () {
				activeUser = $(this).attr("name")
				showUser(activeUser)
			})
			// Click Nav Buttons
			let activeBtn = "nav"
			$("header ul").on("click", ".btn_nav", function () {
				activeBtn = $(this).attr("name")

				if (activeBtn === "nav") {
					$("#btn_add_nav").show()
					$("#btn_add_action").hide()
				} else if (activeBtn === "action") {
					$("#btn_add_nav").hide()
					$("#btn_add_action").show()
				}
				else {
					$("#btn_add_nav").hide()
					$("#btn_add_action").hide()
				}

			})
			// Add Button New Row 
			$("#btn_add_nav").click(function () {
				$(`#${activeUser}`).append(newTableRow_Nav(activeUser, users))
			})
			$("#btn_add_action").click(function () {
				rowToUpdate = null
			})


			//Delete Row
			$(".adapter-container").on("click", ".deleteRow, .deleteEveryRow", function () {
				$(this).parent().parent().remove()
				_onChange()
				generateNav()
			})
			// Eventhandler for save change 

			$("#user_list").on("click", ".click-user", function () {
				activeUser = $(this).attr("name")
				$("#btn-nav").attr("href", `#tab-nav-user-${activeUser}`)
				$("#btn_action").attr("href", `#tab-todo-user-${activeUser}`)
				$("adapter-container").load(`#tab-nav-user-${activeUser}`)
			})
			// update
			$("#navigation").change(".value", function () {
				_onChange()
			})
			$(".valCheckbox").change(function () {
				_onChange()
			})
			//ID Dialog
			$(".adapter-container").on("click", ".btn_getID", function () {
				let $element = $(this).parent().prev().children("input")
				showSelectIdDialog($element.val(), function (newID) {
					$element.val(newID)
				})
			});

			//Modal
			$('.modal').modal()


			// Select Instance			
			getAllTelegramInstances(socket, this)
			$("#select_instance").on('change', function () {

				_onChange()
			})


			// Select Inizializieren
			$("select").select();
			// Select Updaten
			$('select').on('DOMSubtreeModified', function () {
				$(this).select();
			});



			// Tables in Action Verstecken und Button new Row
			$(".modal-content table").hide()
			$("#btn_action_newRow").hide()

			// Bei Änderungen von Select in Action Table anzeigen
			$("#select_action").on("change", function () {
				$("#btn_action_newRow").show()
				$(".modal-content table").hide()
				$(`#tab_${$(this).val()}`).show()
			})
			// New Row in Action 
			$("#btn_action_newRow").on("click", function () {
				$(`#tab_${$("#select_action").val()} tbody`).append(newTrInAction($("#select_action").val()))
				$("#btn_action_set").attr("disabled", "disabled")
			})
			// Global delete Hide Table
			$("div.adapter-container").on("DOMSubtreeModified", "table tbody", function () {
				if ($(this).children("tr").length > 1) {
					$(this).find($("a.deleteRow")).removeAttr("disabled")
				} else $(this).find($("a.deleteRow")).attr("disabled", "disabled")
			})

			// Show Hide Tbody
			$(".adapter-container").on("click", ".showHideMenu", function () {
				$(this).siblings("table").toggle()
				if ($(this).siblings("table").attr("style") === "display: none;") {
					$(this).find("i").html("chevron_right")
				} else $(this).find("i").html("expand_more")
			})
			// Save from Action Input Field
			$("#btn_action_set").on("click", function () {
				let action = $("#select_action").val()
				let $table = $(`#tab_${action} tbody`)
				let result = {
					IDs: [],
					values: [],
					checkboxes: [],
					text: [],
					trigger: $("#select_trigger").val(),
					action: action

				}

				if (action === "set") {
					$($table).find(`input.set_id`).each(function () {
						result.IDs.push($(this).val())
					})
					$($table).find(`input.set_value`).each(function () {
						result.values.push($(this).val())
					})
					$($table).find(`input.switch_checkbox`).each(function () {
						result.checkboxes.push($(this).is(":checked"))
					})
				}

				if (action === "get") {
					$($table).find(`input.get_id`).each(function () {
						result.IDs.push($(this).val())
					})
					$($table).find(`input.get_text`).each(function () {
						result.text.push($(this).val())
					})
					$($table).find(`input.newline_checkbox`).each(function () {
						result.checkboxes.push($(this).is(":checked"))
					})
				}
				generatActionRow(activeUser, action, result, rowToUpdate)
				_onChange()
				resetModal()
			})
			// Reset Modal Input Fields
			$("#btn_action_close").on("click", function () {
				resetModal()
			})
			// Save Button erst anzeigen wenn alles ausgefüllt ist
			// Select Check if is selected
			let showTrigger = false
			let show
			$("#select_trigger").on("change", function () {
				showTrigger = true
				if ($(this).val() == null) showTrigger = false
				showSelectModal(showTrigger, show)
			})
			// Inputs if its not ""
			$(".modal-content").on("input", function () {
				show = true
				$(".checkValue").each(function () {
					const act = $("#select_action").val()
					$(`table#tab_${act} .checkValue`).each(function () {
						if ($(this).val() == "") {
							show = false
						}
					})
				})
				showSelectModal(showTrigger, show)
			})
			// Edit entrys
			$(".adapter-container").on("click", ".editEntry", function () {
				rowToUpdate = $(this).parents("tr")
				showTrigger = true;
				// Select Button Aktivieren
				$("#btn_action_set").removeAttr("disabled")
				$("#btn_action_newRow").show()
				let action = $(this).parents("tbody").attr("data-name")
				$("#select_action").val(action).select()
				$(`#tab_${action}`).show()
				// Trigger	
				$("#select_trigger").val($(this).parent().siblings("[data-name='trigger']").html()).select()
				insertEditValues(action, this)
			})
			// Global User Button
			$("#addGlobalUser").click(function () {
				$(this).addClass("disabled")
				$("#usersForGlobal").val("")
				addNewUser(users, "Global", _onChange)
			})
			$(".modal-content").on("change", ".switch_checkbox", function () {

				if ($(this).is(":checked")) {
					$(this).parent().parent().find("td input.set_value").attr("disabled", "disabled")

				} else $(this).parent().parent().find("td input.set_value").removeAttr("disabled")
			})

		})



	</script>

</head>

<body id="body">
	<div class="m adapter-container">
		<header class="row">
			<div class="row">
				<div class="col s12 m4 l2">
					<img src="telegram-menu.png" class="logo">
				</div>
			</div>
			<div class="row">
				<div class="col s12">
					<ul class="tabs">
						<li class="tab col s3"><a class="active btn_nav translate" name="nav" id="btn-nav"
								href="#tab-nav">Navigation</a>
						</li>
						<li class="tab col s3"><a class="btn_nav translate" name="action" id="btn_action"
								href="#tab-action">Action</a>
						</li>
						<li class="tab col s3"><a class="btn_nav translate" name="set" id="btn_settings"
								href="#tab-settings">Settings</a>
						</li>
					</ul>
				</div>
			</div>
			<!-- Action Popup -->
			<div id="tab_action" class="modal modal-fixed-footer">
				<div class="modal-header">
				</div>
				<div class="modal-content">
					<div class="row">
						<div class="input-field col s3">
							<select id="select_action" class="reset">
								<option value="" disabled selected>Choose your option</option>
								<option value="get">GetState</option>
								<option value="set">SetState</option>
							</select>
							<label>What is to do?</label>
						</div>
						<div class="input-field col s3">
							<select id="select_trigger" class="materialSelect reset checkValue">
								<option value="" disabled selected>Choose your option</option>
							</select>
							<label>Trigger</label>
						</div>
					</div>
					<div class="row">
						<div class="col s12">
							<a class="resetHide btn-floating btn-small waves-effect waves-light blue"
								id="btn_action_newRow" title="Add new Line"><i class="material-icons">add</i></a>
						</div>
					</div>
					<table id="tab_set" class="resetHide">
						<thead>
							<tr>
								<th style="width: 30%; background: #64b5f6 ">ID</th>
								<th style="width: 5%; background: #64b5f6 "></th>
								<th style="background: #64b5f6 ">Value</th>
								<th style="width: 8%; background: #64b5f6 ">Switch</th>
								<th style="width: 3%; background: #64b5f6 "></th>
							</tr>
						</thead>
						<tbody class="table-lines table-values">
							<tr>
								<td> <input class="set_id resetInput checkValue" type="text">
								</td>
								<td><a class="btn-floating btn-small waves-effect waves-light blue btn_getID"
										title="Get ID"><i class="material-icons">edit</i></a></td>
								<td>
									<input class="set_value resetInput checkValue" type="text">
								</td>
								<td>
									<input id="switch_checkbox" type="checkbox" class="filled-in switch_checkbox " />
									<span></span>
								</td>
								<td><a class="deleteRow btn-floating btn-small waves-effect waves-light red" disabled><i
											class="material-icons" disabled>delete</i></a></td>
								</td>
							</tr>
						</tbody>
					</table>
					<table id="tab_get" class="resetHide">
						<thead>
							<tr>
								<th style="width: 30%;">ID</th>
								<th style="width: 5%;"></th>
								<th>Text</th>
								<th style="width: 8%;">Newline</th>
								<th style="width: 3%;"></th>
							</tr>
						</thead>
						<tbody class="table-lines table-values">
							<tr>
								<td> <input class="get_id resetInput checkValue" type="text">
								</td>
								<td><a class="btn-floating btn-small waves-effect waves-light blue btn_getID"
										title="Get ID"><i class="material-icons">edit</i></a></td>
								<td>
									<input class="get_text resetInput checkValue" type="text">
								</td>
								<td><label>
										<input type="checkbox" class="filled-in newline_checkbox" checked />
										<span></span>
									</label></td>

								<td><a class="deleteRow btn-floating btn-small waves-effect waves-light red" disabled><i
											class="material-icons">delete</i></a></td>
								</td>

							</tr>
						</tbody>
					</table>

				</div>
				<div class="modal-footer">
					<a class="modal-action modal-close waves-effect waves-green btn btn-set" id="btn_action_set"
						disabled><i class="large material-icons left">check</i><span class="translate">Save</span></a>
					<a class="modal-action modal-close waves-effect waves-green btn btn-close" id="btn_action_close"><i
							class="large material-icons left ">close</i><span class="translate">Close</span></a>
				</div>

			</div>
			<div class="row" id="user_menu">
				<a class="btn-add btn-floating btn-small waves-effect waves-light blue disabled translateT"
					id="addNewUser" title="Add new User"><i class="material-icons">person_add</i></a>
				<a class="delete btn-floating btn-small waves-effect waves-light red translateT" id="deleteUser"
					title="Delete User"><i class="material-icons">delete</i></a>
				<a class="btn-add btn-floating btn-large waves-effect waves-light blue disabled translateT"
					id="addGlobalUser" title="Add Global User"><i class="material-icons">group_add</i></a>

				<div class="input-field col s3">
					<input id="username" type="text" class="validate">
					<label for="username" class="translate">Add new Username</label>
				</div>
			</div>
			<div class="row">
				<div class="col s12">
					<ul class="tabs" id="user_list">
					</ul>
				</div>
			</div>


			<div class="row">
				<div class="col s12">
					<div class="col s2">
						<a class="btn-add btn-floating btn-small waves-effect waves-light blue translateT"
							id="btn_add_nav" name="nav" title="Add new Navigation"><i
								class="material-icons translate ">add</i></a>
						<a class="btn-add btn-floating btn-small waves-effect waves-light blue translateT modal-trigger"
							id="btn_add_action" name="action" title="Add new Action" data-target="tab_action"
							style="display: none;"><i class="material-icons translate ">add</i></a>
					</div>
					<div class="col s6">
						<label class="showGlobal">
							<input id="usersForGlobal" type="text" class="value">
							<span class="translate">All User from Telegram, seperate with</span><span> ","</span>
						</label>
					</div>
					<div class="col s3">
						<label class="showGlobal">
							<input id="globalUserActiv" type="checkbox" class="filled-in valCheckbox" />
							<span class="translate">Global User activ</span>
						</label>
					</div>

				</div>
			</div>
		</header>
		<div id="tab-nav" class="">
			<div class="row">
				<div class="col s12">
					<div class="table-values-div saveTable" id="navigation">
						<table id="table_nav" class="" style="width: 100%;">
							<thead>
								<tr>
									<th data-name="name" style="width: 20%; background: #64b5f6 " class="translate">Call
										Text
									</th>
									<th data-name="nav" data-type="string" style="background: #64b5f6">
										Navigation</th>
									<th data-name="text" data-type="string" style="background: #64b5f6; width: 20%;">
										Text</th>
									<th style="background: #64b5f6; width: 5%;"></th>
								</tr>
							</thead>
						</table>
					</div>
				</div>

			</div>
		</div>
		<div id="tab-action">

		</div>

		<div id="tab-settings">
			<div class=" row">
				<div class="col s12">
					<h1 class="translate">Settings</h1>
					<div class="row">
						<div class="input-field col s3">
							<select id="select_instance" class="materialSelect reset checkValue">
							</select>
							<label>Instance</label>
						</div>
						<!-- <div class="col s2">
							<label>
								<input id="instance" type="text" class="value" value="telegram.0">
								<span class="translate">Instanze</span>
							</label>
						</div> -->
						<!-- <div class="input-field col s2">
							<input placeholder="," id="sepBtn" type="text" class="validate center-align value">
							<label for="sepBtn">Separation buttons</label>
						</div>
						<div class="input-field col s2 offset-s2">
							<input placeholder="&&" id="sepRow" type="text" class="validate center-align value">
							<label for="sepRow">Separation Row</label>
						</div> -->
						<!-- <div class="input-field col s2 offset-s2">
							<input placeholder="%%" id="placeholder_text" type="text"
								class="validate center-align value">
							<label for="sepRow">Placeholder Send Text</label>
						</div> -->

					</div>
					<div class="row">
						<div class="input-field col s3">
							<label>
								<input id="resKey" type="checkbox" class="filled-in valCheckbox" checked />
								<span>Resize Keyboard</span>
							</label>
						</div>
						<div class="input-field col s3">
							<label>
								<input id="oneTiKey" class="filled-in valCheckbox" type="checkbox">
								<span>One Time Keyboard</span>
							</label>

						</div>
					</div>


				</div>

			</div>
		</div>
		<div class="m material-dialogs">
			<div id="dialog-select-member" class="modal modal-fixed-footer">
				<div class="modal-content">
					<div class="row">
						<div class="col s12 title"></div>
					</div>
					<div class="row">
						<div class="col s12 dialog-content">
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<a class="modal-action modal-close waves-effect waves-green btn btn-set"><i
							class="large material-icons left">check</i><span class="translate">Select</span></a>
					<a class="modal-action modal-close waves-effect waves-green btn btn-close"><i
							class="large material-icons left ">close</i><span class="translate">Cancel</span></a>
				</div>
			</div>
		</div>
	</div>


</body>

</html>